# AI-Anime 实施计划

> 基于 README 验收标准与评估报告，按优先级编排的实施路线图。

---

## 一、阶段概览

| 阶段 | 目标 | 预估 |
|------|------|------|
| 阶段一 | 核心流程闭环：成片 + 生成物下载 | 2–3 周 |
| 阶段二 | 质量与运维：可观测性 + AI 成本 | 1–2 周 |
| 阶段三 | 任务编排与审核增强 | 1–2 周 |
| 阶段四 | 测试与增强 | 持续 |

---

## 二、阶段一：核心流程闭环

### 2.1 成片模块

**目标**：完成「镜头 → 成片 → 导出」闭环。

| 任务 | 说明 | 依赖 |
|------|------|------|
| 1.1.1 成片 Service | `module/composite/` 或扩展现有 episode：CompositeTask CRUD、状态机（editing→exporting→done） | CompositeTask 表 |
| 1.1.2 成片 Worker | Asynq 任务：合并镜头视频、音频、字幕，输出成片文件 | Storage、FFmpeg 或合成能力 |
| 1.1.3 成片 API | 创建导出任务、查询状态、获取成片 URL | Worker |
| 1.1.4 成片前端 | 时间线页、导出入口、进度展示 | API |

### 2.2 生成物下载

**目标**：单文件下载 + 按集打包 ZIP。

| 任务 | 说明 | 依赖 |
|------|------|------|
| 1.2.1 单文件下载 API | `GET /projects/:id/.../download?url=xxx` 或签名 URL 直链 | Storage |
| 1.2.2 按集打包 Worker | 根据 PackageConfig 收集镜图/镜头/成片，打包 ZIP，写入 Storage | 1.1 |
| 1.2.3 打包任务 API | 完善 RequestPackage：入队、返回 task_id、轮询下载 | Worker |
| 1.2.4 前端下载入口 | 单文件下载按钮、按集打包入口 | API |

---

## 三、阶段二：质量与运维

### 3.1 可观测性

**目标**：暴露 Prometheus 指标、接入 OpenTelemetry。

| 任务 | 说明 | 依赖 |
|------|------|------|
| 2.1.1 Prometheus /metrics | 引入 `prometheus/client_golang`，暴露 `/metrics` 端点 | 无 |
| 2.1.2 指标埋点 | 请求延迟、错误率、AI 调用耗时、任务队列积压 | 无 |
| 2.1.3 OpenTelemetry | 跨请求 Trace、Span 关联 AI Provider 调用 | 可选 |
| 2.1.4 Grafana 仪表盘 | 提供 dashboards JSON 或文档 | 2.1.1 |

### 3.2 AI 成本控制

**目标**：用量统计、预算控制或告警。

| 任务 | 说明 | 依赖 |
|------|------|------|
| 2.2.1 ProviderUsage 写入 | 在 mesh/Provider 调用处记录 token、图片数、视频秒数 | provider_usages 表 |
| 2.2.2 用量查询 API | 按项目/用户/时间范围查询 | 无 |
| 2.2.3 预算告警 | 项目级预算上限、超限告警或拒绝 | 可选 |

---

## 四、阶段三：任务编排与审核增强

### 4.1 定时任务调度

**目标**：Schedule 表驱动的 cron 执行。

| 任务 | 说明 | 依赖 |
|------|------|------|
| 3.1.1 调度器 | 使用 robfig/cron 或类似，读取 schedules 表，按 cron_expr 触发 | Schedule 表 |
| 3.1.2 调度 API | 创建/更新/删除定时任务 | 无 |
| 3.1.3 任务触发 | 触发流水线或批量任务（如批量镜图生成） | 现有 Worker |

### 4.2 审核闭环

**目标**：审核不通过 → 反馈 → 重试。

| 任务 | 说明 | 依赖 |
|------|------|------|
| 3.2.1 ReviewRecord 写入 | 审核通过/拒绝时写入 review_records | review_records 表 |
| 3.2.2 不通过闭环 | rejected → regenerating → review 状态机 | 现有审核逻辑 |
| 3.2.3 审核方式配置 | 人工/AI/人工+AI 可配置（项目级或全局） | 可选 |

---

## 五、阶段四：测试与增强

### 5.1 测试

| 任务 | 说明 |
|------|------|
| 4.1.1 单元测试 | 核心 Service（shot、shot_image、notification 等） |
| 4.1.2 集成测试 | API 端到端（登录、生成、审核） |
| 4.1.3 E2E | 主流程（剧本→资产→脚本→镜图→成片） |

### 5.2 增强通知

| 任务 | 说明 |
|------|------|
| 4.2.1 浏览器 Push | 需用户授权，任务完成时推送 |
| 4.2.2 声音提醒 | 可选 |

---

## 六、实施顺序建议

```
阶段一（必做）
├── 1.1.1 成片 Service
├── 1.1.2 成片 Worker
├── 1.1.3 成片 API
├── 1.2.1 单文件下载 API
├── 1.2.2 按集打包 Worker
├── 1.2.3 打包任务 API
└── 1.1.4 + 1.2.4 前端

阶段二（建议上线前完成）
├── 2.1.1 Prometheus /metrics
├── 2.2.1 ProviderUsage 写入
└── 2.1.2 指标埋点

阶段三（按需）
├── 3.1 定时任务
├── 3.2.1 ReviewRecord 写入
└── 3.2.2 不通过闭环

阶段四（持续）
└── 测试 + 增强
```

---

## 七、风险与依赖

| 风险 | 缓解 |
|------|------|
| 成片合成依赖 FFmpeg 或视频服务 | 需确认技术选型；可先用占位或简单拼接 |
| 按集打包大文件内存 | 流式 ZIP、临时文件及时清理 |
| 可观测性依赖 | Prometheus 可选；先保证基础日志 |

---

## 八、检查点

- [ ] 阶段一完成：可完整走通「剧本→成片→导出」流程
- [ ] 阶段二完成：可观测、可统计 AI 成本
- [ ] 阶段三完成：可配置定时任务、审核闭环
- [ ] 阶段四完成：核心路径有测试覆盖
